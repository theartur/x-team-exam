<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Discount Ascii Warehouse</title>
        <style type="text/css">
            
            .loading {
                cursor: wait;
                background: #fff;
                width: 10px;
                height: 10px;
                margin: 33px auto;
                border-top: 10px solid #00f;
                border-left: 10px solid #88f;
                border-bottom: 10px solid #bbf;
                border-right: 10px solid #eef;
                animation: spinner 1.1s linear infinite;
                border-radius: 50%;
            }
            
            @keyframes spinner {
                to {transform: rotate(360deg);}
            }
            
            .products table {
                border: 1px solid #fafafa;
                width: 100%;
                font-family: sans-serif;
            }
            
            .products table td {
                padding: 10px;
                background: #fafafa;
                text-align: center;
            }
            
            .products tbody tr:hover td {
                background: #fff;
            }
            
            .products table td.ad {
                text-align: center;
                padding: 20px;
            }
            
            .products table td.ad span {
                color: #fff;
                text-shadow: 0 0 5px #000;
                position: relative;
                left: -50px;
                top: -20px;
            }
        </style>
    </head>
    <body>
        <header>
            <h1>Discount Ascii Warehouse</h1>

            <p>Here you're sure to find a bargain on some of the finest ascii available to purchase. Be sure to peruse our selection of ascii faces in an exciting range of sizes and prices.</p>

            <p>But first, a word from our sponsors:</p>
        </header>

        <section class="products">
           <table>
               <thead>
                   <tr>
                       <th class="sortable">ID</th>
                       <th>Face</th>
                       <th class="sortable">Font Size</th>
                       <th class="sortable">Price</th>
                       <th>Date</th>
                   </tr>
               </thead>
               <tbody></tbody>
            </table>
        </section>
        
        <script>
            var adIndex = Math.floor(Math.random()*1000);
            
            function getAd() {
                adIndex = Math.floor((adIndex + Math.floor(Math.random()*1000)) / 2);
                var ad = document.createElement('img');
                ad.classList.add('ad');
                ad.src = '/ad/?r=' + adIndex;
                return ad;
            }

            function getProducts(limit, skip, sort) {
                var defer = {then:function(cb){this.cb=cb}}; // one line promise
                // lock throttle
                infinityScroll.lock();
                var req = new XMLHttpRequest();
                var params = "?limit=" + (limit || 0) + "&skip=" + (skip || 0) + "&sort=" + (sort || 'id','');

                req.open("get", "/api/products" + params);
                req.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        var res = this.responseText;
                        try {
                            var productList = "[" + res.trim().split("\n").join(",") + "]";

                            console.log("productList", productList.length, "bytes");
                            var products = JSON.parse(productList);

                            console.log("products", products.length);
                            if (defer.cb) {
                                defer.cb(products);
                                defer.cb = null;
                            } else {
                                console.log("ELSE", defer.cb);
                            }
                        } catch (e) {
                            console.log("CATCH ERROR", e, e.stack);
                            if (defer.cb) {
                                defer.cb(null);
                            }
                        }
                    }
                }
                
                req.send();

                return defer;
            }

            function append(elem, child) {
                return elem.appendChild(child);
            }

            function createCell(text) {
                var cell = document.createElement("td");
                cell.innerText = text || "";
                return cell;
            }

            function createCellFace(product) {
                var cell = createCell(product.face);
                cell.style.fontSize = product.size + "px";
                return cell;
            }

            function createCellSize(size) {
                size = size + "px";
                var cell = createCell(size);
                cell.style.fontSize = size;
                return cell;
            }

            function createCellPrice(price) {
                var cell = createCell("$"+(price/100).toFixed(2));
                return cell;
            }
            
            function relativeDate(date) {
                
                date = new Date(date);
                var local = new Date(date);
                local.setMinutes(date.getMinutes() - date.getTimezoneOffset());
                
//                     return local.toJSON().slice(0, 10);
                
                var diff = (+new Date) - (+new Date(local));
                var ago = "some time ago";
                
                function pluralize(n) {
                    return n|0>1?'s':'';
                }
                
                console.log(ago, +new Date(date), date, diff);
                
                if (diff < 1000) {
                    ago = Math.round(diff) + " ms ago";
                    console.log("ms ago", ago, diff);

                    return ago;
                }
                
                diff /= 1000;
                
                if (diff < 60) {
                    ago = Math.round(diff) + " second" + pluralize(diff) + " ago";
                    console.log("s ago", ago, diff);

                    return ago;
                }
                
                diff /= 60;
                
                if (diff < 60) {
                    ago = Math.round(diff) + " minute" + pluralize(diff) + " ago";
                    console.log("minutes ago", ago, diff);

                    return ago;
                }
                
                diff /= 60;
                
                if (diff < 24) {
                    ago = Math.round(diff) + " hour" + pluralize(diff) + " ago";
                    console.log("hours ago", ago, diff);

                    return ago;
                }
                
                diff /= 24;
                
                if (diff <= 7) {
                    ago = Math.round(diff) + " day" + pluralize(diff) + " ago";
                    console.log("days ago", ago, diff);

                    return ago;
                }
                
                diff /= 7;
                
                if (diff > 1) {
                    ago = date.toJSON().slice(0, 10);
                    console.log("week" + pluralize(diff) + " ago", ago, diff);

                    return ago;
                }
            }
            
            function createCellDate(date) {
                var cell = createCell(relativeDate(date));
                return cell;
            }

            function createRow(product) {
                var row = document.createElement("tr");

                append(row, createCell(product.id));
                append(row, createCellFace(product));
                append(row, createCellSize(product.size));
                append(row, createCellPrice(product.price));
                append(row, createCellDate(product.date));

                return row;
            }

            function createAdRow() {
                console.log("createAdRow");
                var row = document.createElement("tr");
                var distinct = document.createElement("span");
                var ad = createCell();
                
                ad.colSpan = 5;
                ad.classList.add('ad');
                distinct.innerText = adIndex;
                
                append(ad, getAd());
                append(ad, distinct);
                append(row, ad);

                return row;
            }

            function populateGrid (products) {
                console.log("THEN", products.length);
                // release throttle
                infinityScroll.unlock();
                products.map(function (product, i) {
                    insertRowIntoGrid(createRow(product));
                    
                    if (productIndex && (productIndex % 20 == 0)) {
                        console.log("SHOW AD", productIndex, productIndex % 20);
                        insertRowIntoGrid(createAdRow());
                    }
                    
                    productIndex++;
                });
            }

            function insertRowIntoGrid(row) {
                append(gridBody, row);
            }

            function infinityScroll(e) {
                var html = document.documentElement;
                var windowHeight = html.clientHeight;
                var triggerPoint = windowHeight * 5;
                var pxToEnd = html.scrollHeight - (window.scrollY + windowHeight);

                if (canInfinityScroll && pxToEnd < triggerPoint) {
                    console.log("GET MORE!!!", productIndex, pxToEnd, windowHeight);
                    getProducts(100, productIndex).then(populateGrid);
                }
            }
            
            function loading() {
                this.node = document.createElement("div");
                this.show = function () {
                    this.node.style.display = "block";
                };
                this.hide = function () {
                    this.node.style.display = "none";
                };
                
                this.node.classList.add("loading");
                
                return this;
            }
            
            
            infinityScroll.unlock = function () {
                canInfinityScroll = true;
                loader.hide();
            }
            
            infinityScroll.lock = function () {
                canInfinityScroll = false;
                loader.show();
            }

            function throttle(fn, delta) {
                var last = +new Date;
                return function () {
                    var diff = (+new Date) - last;
                    if (diff >= delta) {
                        fn.apply(this, arguments);
                        last = +new Date;
                    }
                };
            }

            var productsSection = document.querySelector(".products");
            var gridBody = document.querySelector(".products tbody");
            var loader = new loading();
            var productIndex = 0;
            var canInfinityScroll = true;

            getProducts(100).then(populateGrid);

            document.querySelector("body header").appendChild(getAd());
            
            append(productsSection, loader.node);

            document.addEventListener("scroll", throttle(infinityScroll, 250));

            //                 document.write('<img class="ad" src="/ad/?r=' + adIndex + '"/>');
        </script>
    </body>
</html>
