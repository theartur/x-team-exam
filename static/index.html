<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Discount Ascii Warehouse</title>
        <style type="text/css">
            
            .loading { cursor: wait; }
            
            .products table {
                border: 1px solid #fafafa;
                width: 100%;
                font-family: sans-serif;
            }
            
            .products table td {
                padding: 10px;
                background: #fafafa;
                text-align: center;
            }
            
            .products table td.ad {
                text-align: center;
                padding: 20px;
            }
        </style>
    </head>
    <body>
        <header>
            <h1>Discount Ascii Warehouse</h1>

            <p>Here you're sure to find a bargain on some of the finest ascii available to purchase. Be sure to peruse our selection of ascii faces in an exciting range of sizes and prices.</p>

            <p>But first, a word from our sponsors:</p>
        </header>

        <section class="products">
           <table>
               <thead>
                   <tr>
                       <td>ID</td>
                       <td>Face</td>
                       <td>Font Size</td>
                       <td>Price</td>
                       <td>Date</td>
                   </tr>
               </thead>
               <tbody>
                   <tr>
                       <td>1</td>
                       <td>;}-</td>
                       <td>111 px</td>
                       <td>$222.00</td>
                       <td>333 days ago</td>
                   </tr>
               </tbody>
            </table>
        </section>
        
        <script>
            function getAd() {
                var adIndex = Math.floor(Math.random()*1000);
                var ad = document.createElement('img');
                ad.classList.add('ad');
                ad.src = '/ad/?r=' + adIndex;
                return ad;
            }

            function getProducts(limit, skip) {
                var defer = {then:function(cb){this.cb=cb}}; // one line promise
                // lock throttle
                canInfinityScroll = false;
                var req = new XMLHttpRequest();
                var params = "?limit=" + (limit || 0) + "&skip=" + (skip || 0);

                req.open("get", "/api/products" + params);
                req.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        var res = this.responseText;
                        try {
                            var productList = "[" + res.trim().split("\n").join(",") + "]";

                            console.log("productList", productList.length, "bytes");
                            var products = JSON.parse(productList);

                            console.log("products", products.length);
                            if (defer.cb) {
                                defer.cb(products);
                                defer.cb = null;
                            } else {
                                console.log("ELSE", defer.cb);
                            }
                        } catch (e) {
                            console.log("CATCH ERROR", e, e.stack);
                            if (defer.cb) {
                                defer.cb(null);
                            }
                        }
                    }
                }
                req.send();

                return defer;
            }

            function append(elem, child) {
                return elem.appendChild(child);
            }

            function createCell(text) {
                var cell = document.createElement("td");
                cell.innerText = text || "";
                return cell;
            }

            function createCellFace(product) {
                var cell = createCell(product.face);
                cell.style.fontSize = product.size + "px";
                return cell;
            }

            function createCellSize(size) {
                size = size + "px";
                var cell = createCell(size);
                cell.style.fontSize = size;
                return cell;
            }

            function createCellPrice(price) {
                var cell = createCell("$"+(price/100).toFixed(2));
                return cell;
            }
            
            function relativeDate(date) {
                // todo: reference date (333 days ago)
                // precision (ms,s,m,h,d,m,a);
                
                date = new Date(date);
                var local = new Date(date);
                local.setMinutes(date.getMinutes() - date.getTimezoneOffset());
                
//                     return local.toJSON().slice(0, 10);
                
                var diff = (+new Date) - (+new Date(local));
                var ago = "SOME TIME AGO";
                
                console.log(ago, +new Date(date), date, diff);
                
                if (diff < 1000) {
                    ago = Math.round(diff) + " ms ago";
                    console.log("ms ago", ago, diff);

                    return ago;
                }
                
                diff /= 1000;
                
                if (diff < 60) {
                    ago = Math.round(diff) + " seconds ago";
                    console.log("s ago", ago, diff);

                    return ago;
                }
                
                diff /= 60;
                
                if (diff < 60) {
                    ago = Math.round(diff) + " minutes ago";
                    console.log("minutes ago", ago, diff);

                    return ago;
                }
                
                diff /= 60;
                
                if (diff < 24) {
                    ago = Math.round(diff) + " hours ago";
                    console.log("hours ago", ago, diff);

                    return ago;
                }
                
                diff /= 24;
                
                if (diff <= 7) {
                    ago = Math.round(diff) + " days ago";
                    console.log("days ago", ago, diff);

                    return ago;
                }
                
                diff /= 7;
                
                if (diff > 1) {
                    ago = date.toJSON().slice(0, 10);
                    console.log("weeks ago", ago, diff);

                    return ago;
                }
            }
            
            function createCellDate(date) {
                var cell = createCell(relativeDate(date));
                return cell;
            }

            function createRow(product) {
                var row = document.createElement("tr");

                append(row, createCell(product.id));
                append(row, createCellFace(product));
                append(row, createCellSize(product.size));
                append(row, createCellPrice(product.price));
                append(row, createCellDate(product.date));

                return row;
            }

            function createAdRow() {
                console.log("createAdRow");
                var row = document.createElement("tr");
                var ad = createCell();
                ad.colSpan = 5;
                ad.classList.add('ad');
                
                append(ad, getAd());
                append(row, ad);

                return row;
            }

            function populateGrid (products) {
                console.log("THEN", products.length);
                // release throttle
                canInfinityScroll = true;
                products.map(function (product, i) {
                    insertRowIntoGrid(createRow(product));
                    
                    if (productIndex && (productIndex % 20 == 0)) {
                        console.log("SHOW AD", productIndex, productIndex % 20);
                        insertRowIntoGrid(createAdRow());
                    }
                    
                    productIndex++;
                });
            }

            function insertRowIntoGrid(row) {
                append(gridBody, row);
            }

            var gridBody = document.querySelector(".products tbody");
            var productIndex = 0;
            var canInfinityScroll = true;

            getProducts(100).then(populateGrid);

            document.querySelector("body header").appendChild(getAd());

            function infinityScroll(e) {
                var html = document.documentElement;
                var windowHeight = html.clientHeight;
                var triggerPoint = windowHeight * 5;
                var pxToEnd = html.scrollHeight - (window.scrollY + windowHeight);

                if (canInfinityScroll && pxToEnd < triggerPoint) {
                    console.log("GET MORE!!!", productIndex, pxToEnd, windowHeight);
                    getProducts(100, productIndex).then(populateGrid);
                }
            }

            function throttle(fn, delta) {
                var last = +new Date;
                return function () {
                    var diff = (+new Date) - last;
                    if (diff >= delta) {
                        fn.apply(this, arguments);
                        last = +new Date;
                    }
                };
            }

            document.addEventListener("scroll", throttle(infinityScroll, 250));

            //                 document.write('<img class="ad" src="/ad/?r=' + adIndex + '"/>');
        </script>
    </body>
</html>
